<!-- 
'xs': '320px',
'sm': '640px',
'md': '768px',
'lg': '1024px',
'xl': '1280px',
'2xl': '1536px',
'desktop': '1200px',  
-->
<template>
    <div>
        <div class="container mx-auto px-4 py-14">
            <div class="flex flex-col gap-15">
                <!-- ë¬¸ì˜ ìƒë‹¨ -->
                <div
                    v-motion
                    :initial="{ opacity: 0, y: 20 }"
                    :visible-once="{ opacity: 1, y: 0, transition: { duration: 500 } }"
                    :delay="100"
                    :threshold="0.1"
                    class="flex flex-col items-center justify-between gap-10 border-b-2 border-black md:flex-row"
                >
                    <div class="flex w-full flex-row justify-start gap-6 md:w-auto md:gap-10 lg:gap-20">
                        <div class="whitespace-nowrap text-lg font-extrabold leading-9 md:text-3xl">ë¬¸ì˜</div>
                        <div class="text-[1.4rem] leading-9 md:text-2xl lg:text-3xl">
                            <div class="font-extralight">FOURBERRY</div>
                            <div class="animate-text-shine bg-gradient-to-r from-blue-500 via-pink-500 to-blue-500 bg-[size:200%_auto] bg-clip-text font-black text-transparent">ì„±ê³µì ì¸ íŒŒíŠ¸ë„ˆê°€</div>
                            <div class="font-extralight">ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.</div>
                            <div class="animate-text-shine bg-gradient-to-r from-blue-500 via-pink-500 to-blue-500 bg-[size:200%_auto] bg-clip-text font-black text-transparent">
                                ì§€ê¸ˆ ë°”ë¡œ ë¬¸ì˜í•˜ì„¸ìš”.
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="flex flex-col items-center justify-between gap-10 md:flex-row">
                            <div>
                                <img src="/images/contact/bg_contact.png" class="w-full max-w-sm" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ìƒë‹´ ëª©ë¡ -->
                <div class="flex flex-col gap-6">
                    <SectionTitle>ìƒë‹´ë¬¸ì˜</SectionTitle>
                    <!-- ë¬¸ì˜ í¼ -->
                    <form @submit.prevent="handleSubmit">
                        <ol class="flex flex-col gap-10 md:gap-15">
                            <!-- ìƒë‹´ ìœ í˜• -->
                            <li v-motion :initial="{ opacity: 0, y: 20 }" :visible-once="{ opacity: 1, y: 0, transition: { duration: 500 } }" :delay="100" :threshold="0.1">
                                <h4 class="mb-1 font-extrabold md:text-lg">ì–´ë–¤ ìœ í˜•ì˜ ìƒë‹´ì„ ì›í•˜ì‹œë‚˜ìš”?</h4>
                                <div class="mb-3 text-xs font-medium md:text-sm">í•„ìˆ˜ ì„ íƒ ğŸ“Œ</div>
                                <ul class="m-0 grid list-none grid-cols-[repeat(auto-fit,_minmax(130px,_1fr))] gap-3 p-0">
                                    <li v-for="type in consultationTypes" :key="type.id">
                                        <input type="radio" name="rdoType" :id="type.id" :value="type.value" class="peer hidden" v-model="selectedType" />
                                        <label
                                            :for="type.id"
                                            class="flex w-full cursor-pointer items-center justify-center truncate rounded-md border border-gray-300 bg-white px-2 py-3 text-center text-sm font-medium text-gray-700 hover:bg-gray-50 peer-checked:border-primary peer-checked:bg-primary peer-checked:font-bold peer-checked:text-white md:text-base"
                                        >
                                            {{ type.label }}
                                        </label>
                                    </li>
                                </ul>
                            </li>
                            <!-- ê´€ì‹¬ ì„œë¹„ìŠ¤ -->
                            <li v-motion :initial="{ opacity: 0, y: 20 }" :visible-once="{ opacity: 1, y: 0, transition: { duration: 500 } }" :delay="100" :threshold="0.1">
                                <h4 class="mb-1 font-extrabold md:text-lg">ê´€ì‹¬ ì„œë¹„ìŠ¤ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</h4>
                                <div class="mb-3 text-xs font-medium md:text-sm">ë‹¤ì¤‘ ì„ íƒ ğŸ“š</div>
                                <ul class="m-0 grid list-none grid-cols-[repeat(auto-fit,_minmax(130px,_1fr))] gap-3 p-0">
                                    <li v-for="service in favoriteServices" :key="service.id">
                                        <input type="checkbox" :id="service.id" :value="service.value" class="peer hidden" v-model="selectedServices" />
                                        <label
                                            :for="service.id"
                                            class="flex w-full cursor-pointer items-center justify-center truncate rounded-md border border-gray-300 bg-white px-2 py-3 text-center text-sm font-medium text-gray-700 hover:bg-gray-50 peer-checked:border-primary peer-checked:bg-primary peer-checked:font-bold peer-checked:text-white md:text-base"
                                        >
                                            {{ service.label }}
                                        </label>
                                    </li>
                                </ul>
                            </li>
                            <!-- ì˜ˆì‚°/ì¼ì • -->
                            <li v-motion :initial="{ opacity: 0, y: 20 }" :visible-once="{ opacity: 1, y: 0, transition: { duration: 500 } }" :delay="100" :threshold="0.1">
                                <h4 class="mb-3 font-extrabold md:text-lg">ì˜ˆì‚°ê³¼ ì¼ì •ì€ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?</h4>
                                <ul class="m-0 grid list-none grid-cols-1 gap-3 p-0 md:grid-cols-2">
                                    <li>
                                        <FormSelect id="budget_select" placeholder="ì˜ˆì‚°ì„ ì„ íƒí•˜ì„¸ìš”." :options="budgetOptions" v-model="selectedBudget" />
                                    </li>
                                    <li>
                                        <FormSelect id="schedule_select" placeholder="ì¼ì •ì„ ì„ íƒí•˜ì„¸ìš”." :options="scheduleOptions" v-model="selectedSchedule" />
                                    </li>
                                </ul>
                            </li>
                            <!-- ê¸°íƒ€ë‚´ìš©(íŒŒì¼ ì—…ë¡œë“œ) -->
                            <li v-motion :initial="{ opacity: 0, y: 20 }" :visible-once="{ opacity: 1, y: 0, transition: { duration: 500 } }" :delay="100" :threshold="0.1">
                                <h4 class="mb-1 font-extrabold md:text-lg">ì¶”ê°€ë¡œ ì „ë‹¬í•˜ê³  ì‹¶ì€ ë‚´ìš©ì´ ìˆìœ¼ì‹ ê°€ìš”?</h4>
                                <div class="mb-3 text-xs font-medium md:text-sm">êµ¬ì²´ì ì¸ ë‚´ìš©ì„ ì ì–´ì£¼ì‹œë©´ ì´í•´í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.</div>
                                <textarea
                                    rows="5"
                                    class="block w-full rounded-lg border border-gray-300 bg-white p-4 text-sm text-gray-900 focus:border-primary focus:ring-primary md:text-base dark:border-gray-600 dark:bg-gray-50 dark:text-gray-900 dark:placeholder-gray-400 dark:focus:border-primary dark:focus:ring-primary"
                                    placeholder="ì˜ˆ: í”„ë¡œì íŠ¸ ê°œìš”, ìš”êµ¬ì‚¬í•­ ë“±"
                                    v-model="textareaContent"
                                    maxlength="4000"
                                ></textarea>
                                <div class="mb-3 mt-2 text-right text-xs text-gray-500">{{ textareaContent.length }}/4000ì</div>

                                <FormFileUpload id="contact_file_upload" label="íŒŒì¼ ì²¨ë¶€ (ì„ íƒ)" :maxFiles="5" :maxSizeMb="10" v-model="selectedFiles" />
                            </li>

                            <!-- ì˜ë¢°ì¸ ì •ë³´ -->
                            <li v-motion :initial="{ opacity: 0, y: 20 }" :visible-once="{ opacity: 1, y: 0, transition: { duration: 500 } }" :delay="100" :threshold="0.1">
                                <h4 class="mb-3 font-extrabold md:text-lg">ì˜ë¢°í•˜ì‹œëŠ” ë¶„ì˜ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.</h4>

                                <ul class="m-0 grid list-none grid-cols-1 gap-3 p-0 md:grid-cols-2">
                                    <li>
                                        <FormFloatingInput id="client_company" label="íšŒì‚¬/ë‹¨ì²´ëª…" v-model="clientInfo.company" :maxlength="50" :required="true" />
                                    </li>
                                    <li>
                                        <FormFloatingInput id="client_name" label="ë‹´ë‹¹ìëª…" v-model="clientInfo.name" :maxlength="30" :required="true" />
                                    </li>
                                    <li>
                                        <FormFloatingInput id="client_tel" label="ì—°ë½ì²˜" type="tel" v-model="clientInfo.tel" :maxlength="11" :required="true" />
                                    </li>
                                    <li>
                                        <FormFloatingInput id="client_email" label="ì´ë©”ì¼" type="email" v-model="clientInfo.email" :maxlength="100" :required="true" />
                                    </li>
                                </ul>
                            </li>

                            <!-- ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ -->
                            <li v-motion :initial="{ opacity: 0, y: 20 }" :visible-once="{ opacity: 1, y: 0, transition: { duration: 500 } }" :delay="100" :threshold="0.1">
                                <div class="flex items-center">
                                    <input
                                        id="link-checkbox"
                                        type="checkbox"
                                        v-model="isPrivacyAgreed"
                                        class="h-4 w-4 rounded-sm border-gray-300 bg-gray-100 text-primary focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:ring-offset-gray-800 dark:focus:ring-blue-600"
                                    />
                                    <div class="ms-2 text-sm font-medium text-gray-900 md:text-base dark:text-gray-300">
                                        <a href.prevent="" @click="openPrivacyModal" class="text-primary hover:underline dark:text-blue-500">ê°œì¸ì •ë³´ë³´í˜¸ì •ì±…</a>

                                        <label for="link-checkbox" class="cursor-pointer">
                                            ì— ë™ì˜í•©ë‹ˆë‹¤.
                                            <em class="font-bold text-red-600">*</em>
                                        </label>
                                    </div>
                                </div>
                            </li>
                            <!-- ì œì¶œ ë²„íŠ¼ -->
                            <li v-motion :initial="{ opacity: 0, y: 20 }" :visible-once="{ opacity: 1, y: 0, transition: { duration: 500 } }" :delay="100" :threshold="0.1">
                                <BaseButton type="submit" :loading="isLoading" class="animate-pulse-subtle">ë¬¸ì˜í•˜ê¸°</BaseButton>
                            </li>
                        </ol>
                    </form>
                </div>
            </div>
        </div>

        <BaseModal :show="showModal" @close="closeModal">
            <div class="p-6">
                <h3 class="mb-2 text-lg font-bold text-gray-900">
                    {{ modalTitle }}
                </h3>
                <p class="text-sm text-gray-700">
                    {{ modalMessage }}
                </p>
            </div>
        </BaseModal>

        <BaseModal :show="showPrivacyModal" @close="closePrivacyModal">
            <div class="p-6">
                <h3 class="mb-4 text-lg font-bold text-gray-900">ê°œì¸ì •ë³´ë³´í˜¸ì •ì±…</h3>
                <div class="space-y-4 text-sm text-gray-600">
                    <p>
                        <strong>ì œ1ì¡° (ì´ì¹™)</strong>
                        <br />
                        ì£¼ì‹íšŒì‚¬ í¬ë² ë¦¬(ì´í•˜ 'íšŒì‚¬'ë¼ í•¨)ëŠ” ì´ìš©ìì˜ ê°œì¸ì •ë³´ë¥¼ ì¤‘ìš”ì‹œí•˜ë©°, 'ê°œì¸ì •ë³´ ë³´í˜¸ë²•', 'ì •ë³´í†µì‹ ë§ ì´ìš©ì´‰ì§„ ë° ì •ë³´ë³´í˜¸ ë“±ì— ê´€í•œ ë²•ë¥ ' ë“± ê´€ë ¨ ë²•ë ¹ì„ ì¤€ìˆ˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.
                    </p>
                    <p>
                        <strong>ì œ2ì¡° (ìˆ˜ì§‘í•˜ëŠ” ê°œì¸ì •ë³´ì˜ í•­ëª©)</strong>
                        <br />
                        íšŒì‚¬ëŠ” ìƒë‹´, ì„œë¹„ìŠ¤ ì‹ ì²­ ë“±ì„ ìœ„í•´ ì•„ë˜ì™€ ê°™ì€ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤.
                        <br />
                        - í•„ìˆ˜í•­ëª© : ë‹´ë‹¹ìëª…, ì—°ë½ì²˜, ì´ë©”ì¼
                        <br />
                        - ì„ íƒí•­ëª© : íšŒì‚¬/ë‹¨ì²´ëª…, ìƒë‹´ë‚´ìš©, ì²¨ë¶€íŒŒì¼
                    </p>
                    <p>
                        <strong>ì œ3ì¡° (ê°œì¸ì •ë³´ì˜ ìˆ˜ì§‘ ë° ì´ìš©ëª©ì )</strong>
                        <br />
                        íšŒì‚¬ëŠ” ìˆ˜ì§‘í•œ ê°œì¸ì •ë³´ë¥¼ ë‹¤ìŒì˜ ëª©ì ì„ ìœ„í•´ í™œìš©í•©ë‹ˆë‹¤.
                        <br />
                        - ì„œë¹„ìŠ¤ ì œê³µì— ê´€í•œ ê³„ì•½ ì´í–‰ ë° ì„œë¹„ìŠ¤ ì œê³µì— ë”°ë¥¸ ìš”ê¸ˆì •ì‚°
                        <br />
                        - ì½˜í…ì¸  ì œê³µ, êµ¬ë§¤ ë° ìš”ê¸ˆ ê²°ì œ, ë¬¼í’ˆë°°ì†¡ ë˜ëŠ” ì²­êµ¬ì§€ ë“± ë°œì†¡
                        <br />
                        - íšŒì› ê´€ë¦¬: íšŒì›ì œ ì„œë¹„ìŠ¤ ì´ìš©ì— ë”°ë¥¸ ë³¸ì¸í™•ì¸, ê°œì¸ ì‹ë³„, ë¶ˆëŸ‰íšŒì›ì˜ ë¶€ì • ì´ìš© ë°©ì§€ì™€ ë¹„ì¸ê°€ ì‚¬ìš© ë°©ì§€, ê°€ì… ì˜ì‚¬ í™•ì¸, ì—°ë ¹í™•ì¸, ë¶ˆë§Œì²˜ë¦¬ ë“± ë¯¼ì›ì²˜ë¦¬, ê³ ì§€ì‚¬í•­ ì „ë‹¬
                        <br />
                        - ë§ˆì¼€íŒ… ë° ê´‘ê³ ì— í™œìš©: ì‹ ê·œ ì„œë¹„ìŠ¤(ì œí’ˆ) ê°œë°œ ë° íŠ¹í™”, ì´ë²¤íŠ¸ ë“± ê´‘ê³ ì„± ì •ë³´ ì „ë‹¬, ì ‘ì† ë¹ˆë„ íŒŒì•… ë˜ëŠ” íšŒì›ì˜ ì„œë¹„ìŠ¤ ì´ìš©ì— ëŒ€í•œ í†µê³„
                    </p>
                </div>
            </div>
        </BaseModal>
    </div>
</template>

<script setup lang="ts">
import SectionTitle from '@/components/contact/SectionTitle.vue'
import FormFloatingInput from '@/components/contact/FormFloatingInput.vue'
import FormSelect from '@/components/contact/FormSelect.vue'
import FormFileUpload from '@/components/contact/FormFileUpload.vue'
import BaseButton from '@/components/contact/BaseButton.vue'
import BaseModal from '@/components/common/BaseModal.vue'

// ì†”ë£¨ì…˜ ë„ì… ë¬¸ì˜
// ì‹ ê·œ ì‹œìŠ¤í…œ êµ¬ì¶• ì˜ë¢°
// ìœ ì§€ë³´ìˆ˜ ë° ê¸°ìˆ ì§€ì›
// ì‚¬ì—… ì œíœ´ ë° íŒŒíŠ¸ë„ˆì‹­
// ê¸°íƒ€ ì¼ë°˜ ë¬¸ì˜
const consultationTypes = [
    { id: 'TYPE_01', value: 'TYPE_01', label: 'ì‹ ê·œ ì‹œìŠ¤í…œ êµ¬ì¶•' },
    { id: 'TYPE_02', value: 'TYPE_02', label: 'ì‹œìŠ¤í…œ ìœ ì§€ë³´ìˆ˜' },
    { id: 'TYPE_03', value: 'TYPE_03', label: 'ì†”ë£¨ì…˜ ë„ì…' },
    { id: 'TYPE_04', value: 'TYPE_04', label: 'AI ë„ì…' },
    { id: 'TYPE_05', value: 'TYPE_05', label: 'í™ˆí˜ì´ì§€ êµ¬ì¶•' },
    { id: 'TYPE_06', value: 'TYPE_06', label: 'ê¸°íƒ€ ì¼ë°˜ ë¬¸ì˜' },
]

const favoriteServices = [
    { id: 'SERVICE_01', value: 'SERVICE_01', label: 'í†µí•© ì¸ì¦ (SSO)' },
    { id: 'SERVICE_02', value: 'SERVICE_02', label: 'ë°ì´í„° ìŠ¤í¬ë˜í¼' },
    { id: 'SERVICE_03', value: 'SERVICE_03', label: 'í†µí•© ë©”ì‹œì§• (UMS)' },
    { id: 'SERVICE_04', value: 'SERVICE_04', label: 'ì‡¼í•‘ëª° êµ¬ì¶•Â·ìš´ì˜' },
    { id: 'SERVICE_05', value: 'SERVICE_05', label: 'ì£¼ë¬¸ ê´€ë¦¬ (OMS)' },
    { id: 'SERVICE_06', value: 'SERVICE_06', label: 'ê¸°íƒ€ ì‹œìŠ¤í…œ ê°œë°œ' },
]

const budgetOptions = [
    { value: '1000', label: '1000ë§Œì› ë¯¸ë§Œ' },
    { value: '5000', label: '5000ë§Œì› ë¯¸ë§Œ' },
    { value: '10000', label: '1ì–µì› ë¯¸ë§Œ' },
    { value: '30000', label: '3ì–µì› ë¯¸ë§Œ' },
    { value: '50000', label: '5ì–µì› ë¯¸ë§Œ' },
    { value: '70000', label: '7ì–µì› ë¯¸ë§Œ' },
    { value: '0', label: 'ë¯¸ì •' },
]

const scheduleOptions = [
    { value: 'one_month', label: '1ê°œì›” ì´ë‚´' },
    { value: 'three_months', label: '3ê°œì›” ì´ë‚´' },
    { value: 'six_months', label: '6ê°œì›” ì´ë‚´' },
    { value: 'one_year', label: '1ë…„ ì´ë‚´' },
    { value: 'more_than_one_year', label: '1ë…„ ì´ìƒ' },
    { value: 'undecided', label: 'ë¯¸ì •' },
]

const selectedType = ref('') // ìƒë‹´ ìœ í˜•
const selectedServices = ref<string[]>([]) // ê´€ì‹¬ ì„œë¹„ìŠ¤
const selectedBudget = ref('')
const selectedSchedule = ref('')
const textareaContent = ref<string>('') // ì¶”ê°€ ë‚´ìš©
const selectedFiles = ref<File[]>([])
const isLoading = ref(false)
const isPrivacyAgreed = ref(false)

// ì˜ë¢°ì ì •ë³´
const clientInfo = ref({
    company: '',
    name: '',
    tel: '',
    email: '',
})

const showModal = ref(false)
const modalTitle = ref('')
const modalMessage = ref('')
// í¼ ì „ì†¡ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ë¥¼ ì €ì¥ (ëª¨ë‹¬ì„ ë‹«ì„ ë•Œ í¼ì„ ë¦¬ì…‹í• ì§€ ê²°ì •)
const submissionStatus = ref<'success' | 'error' | 'validation' | null>(null)

const showPrivacyModal = ref(false)

const openPrivacyModal = () => {
    showPrivacyModal.value = true
}
const closePrivacyModal = () => {
    showPrivacyModal.value = false
}

/**
 * ëª¨ë‹¬ì„ ë„ìš°ëŠ” í—¬í¼ í•¨ìˆ˜
 */
const openModal = (title: string, message: string, status: 'success' | 'error' | 'validation') => {
    modalTitle.value = title
    modalMessage.value = message
    submissionStatus.value = status
    showModal.value = true
}

/**
 * ëª¨ë‹¬ ë‹«ê¸° í•¸ë“¤ëŸ¬
 */
const closeModal = () => {
    showModal.value = false
    // í¼ ì „ì†¡ì— 'ì„±ê³µ'í–ˆì„ ë•Œë§Œ í¼ì„ ë¦¬ì…‹í•©ë‹ˆë‹¤.
    if (submissionStatus.value === 'success') {
        resetForm()
    }
    submissionStatus.value = null // ìƒíƒœ ì´ˆê¸°í™”
}

/**
 * í¼ ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
 */
const validateForm = (): boolean => {
    // 1. ìƒë‹´ ìœ í˜• (í•„ìˆ˜)
    if (!selectedType.value) {
        openModal('ì…ë ¥ í™•ì¸', 'ì–´ë–¤ ìœ í˜•ì˜ ìƒë‹´ì„ ì›í•˜ì‹œë‚˜ìš”? (í•„ìˆ˜)', 'validation')
        return false
    }

    // 2. ì˜ë¢°ì¸ ì •ë³´ (í•„ìˆ˜)
    // (FormFloatingInputì´ ìì²´ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í•˜ì§€ë§Œ, ìµœì¢… ì œì¶œ ì‹œ í•œ ë²ˆ ë” í™•ì¸)
    const telRegex = /^\d{10,11}$/
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/

    if (!clientInfo.value.name.trim()) {
        openModal('ì…ë ¥ í™•ì¸', 'ë‹´ë‹¹ìëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.', 'validation')
        return false
    }
    if (!clientInfo.value.tel.trim() || !telRegex.test(clientInfo.value.tel)) {
        openModal('ì…ë ¥ í™•ì¸', 'ìœ íš¨í•œ ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (10~11ìë¦¬ ìˆ«ì)', 'validation')
        return false
    }
    if (!clientInfo.value.email.trim() || !emailRegex.test(clientInfo.value.email)) {
        openModal('ì…ë ¥ í™•ì¸', 'ìœ íš¨í•œ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'validation')
        return false
    }

    // 3. ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ (í•„ìˆ˜)
    if (!isPrivacyAgreed.value) {
        openModal('ì…ë ¥ í™•ì¸', 'ê°œì¸ì •ë³´ë³´í˜¸ì •ì±…ì— ë™ì˜í•´ì£¼ì„¸ìš”.', 'validation')
        return false
    }

    return true
}

/**
 * í¼ ì´ˆê¸°í™” í•¨ìˆ˜
 */
const resetForm = () => {
    selectedType.value = ''
    selectedServices.value = []
    textareaContent.value = ''
    clientInfo.value = { company: '', name: '', tel: '', email: '' }
    selectedBudget.value = ''
    selectedSchedule.value = ''
    selectedFiles.value = []
    isPrivacyAgreed.value = false
}

/**
 * File ê°ì²´ë¥¼ Base64 ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
 * (data:mime/type;base64, ì ‘ë‘ì‚¬ ì œê±°)
 */
const readFileAsBase64 = (file: File): Promise<string> => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            const result = reader.result as string;
            
            if (typeof result !== 'string' || !result.includes(',')) {
                // resultê°€ ìœ íš¨í•œ data URL í˜•ì‹ì´ ì•„ë‹Œ ê²½ìš°
                reject(new Error('Failed to read file as base64 data URL.'));
                return;
            }

            // "data:mime/type;base64," ë¶€ë¶„ì„ ì œê±°í•˜ê³  ìˆœìˆ˜ Base64 ë°ì´í„°ë§Œ ë°˜í™˜
            const base64Content = result.split(',')[1];
            
            if (base64Content) {
                // ì„±ê³µì ìœ¼ë¡œ base64 ë¬¸ìì—´ì„ ì¶”ì¶œí•œ ê²½ìš°
                resolve(base64Content);
            } else {
                // ì‰¼í‘œëŠ” ìˆì—ˆì§€ë§Œ, ê·¸ ë’¤ì— ë‚´ìš©ì´ ì—†ëŠ” ë¹„ì •ìƒì ì¸ ê²½ìš°
                reject(new Error('Failed to extract base64 content from data URL.'));
            }
        };
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file);
    });
};

/**
 * API ì œì¶œ í•¸ë“¤ëŸ¬
 */
const handleSubmit = async () => {
    if (isLoading.value) return; // ì¤‘ë³µ ì œì¶œ ë°©ì§€

    // 1. ìœ íš¨ì„± ê²€ì‚¬
    if (!validateForm()) {
        return; // ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨
    }

    isLoading.value = true;

    try {
        // 2. ì²¨ë¶€ íŒŒì¼ Base64 ì¸ì½”ë”© (ë¹„ë™ê¸° ì²˜ë¦¬)
        const attachmentPromises = selectedFiles.value.map(async (file) => {
            const base64Content = await readFileAsBase64(file);
            return {
                filename: file.name,
                mimeType: file.type || 'application/octet-stream', // íŒŒì¼ íƒ€ì…ì´ ì—†ëŠ” ê²½ìš° ëŒ€ë¹„
                content: base64Content,
            };
        });
        
        const attachments = await Promise.all(attachmentPromises);

        // 3. ì´ë©”ì¼ ë³¸ë¬¸(content)ìœ¼ë¡œ ì‚¬ìš©í•  HTML ìƒì„±
        // (ê°€ë…ì„±ì„ ìœ„í•´ ì„ íƒëœ ê°’ì˜ 'label'ì„ ì°¾ì•„ì˜µë‹ˆë‹¤)
        const typeLabel = consultationTypes.find(t => t.value === selectedType.value)?.label || 'N/A';
        const serviceLabels = selectedServices.value
            .map(val => favoriteServices.find(s => s.value === val)?.label)
            .filter(Boolean)
            .join(', ') || 'N/A';
        const budgetLabel = budgetOptions.find(b => b.value === selectedBudget.value)?.label || 'N/A';
        const scheduleLabel = scheduleOptions.find(s => s.value === selectedSchedule.value)?.label || 'N/A';
        
        // (XSS ë°©ì§€ë¥¼ ìœ„í•´ ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ ì´ìŠ¤ì¼€ì´í”„)
        const escapeHTML = (str: string) => str.replace(/[&<>"']/g, match => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        }[match]!));
        
        const htmlContent = `
            <h1>[í¬ë² ë¦¬] ì‹ ê·œ ë¬¸ì˜ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.</h1>
            <p><strong>${escapeHTML(clientInfo.value.company || clientInfo.value.name)}</strong>ë‹˜ìœ¼ë¡œë¶€í„° ìƒˆë¡œìš´ ë¬¸ì˜ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <hr>
            <h2>ë¬¸ì˜ì ì •ë³´</h2>
            <ul>
                <li><strong>íšŒì‚¬/ë‹¨ì²´ëª…:</strong> ${escapeHTML(clientInfo.value.company) || 'N/A'}</li>
                <li><strong>ë‹´ë‹¹ìëª…:</strong> ${escapeHTML(clientInfo.value.name)}</li>
                <li><strong>ì—°ë½ì²˜:</strong> ${escapeHTML(clientInfo.value.tel)}</li>
                <li><strong>ì´ë©”ì¼:</strong> ${escapeHTML(clientInfo.value.email)}</li>
            </ul>
            <hr>
            <h2>ë¬¸ì˜ ë‚´ìš©</h2>
            <ul>
                <li><strong>ìƒë‹´ ìœ í˜•:</strong> ${escapeHTML(typeLabel)}</li>
                <li><strong>ê´€ì‹¬ ì„œë¹„ìŠ¤:</strong> ${escapeHTML(serviceLabels)}</li>
                <li><strong>ì˜ˆì‚°:</strong> ${escapeHTML(budgetLabel)}</li>
                <li><strong>ì¼ì •:</strong> ${escapeHTML(scheduleLabel)}</li>
            </ul>
            <hr>
            <h3>ì¶”ê°€ ì „ë‹¬ ë‚´ìš©</h3>
            <pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f4f4f4; padding: 10px; border-radius: 5px;">${escapeHTML(textareaContent.value) || 'N/A'}</pre>
            <hr>
            <p>ì²¨ë¶€íŒŒì¼: ${attachments.length > 0 ? escapeHTML(attachments.map(a => a.filename).join(', ')) : 'ì—†ìŒ'}</p>
        `;

        // 4. API ìš”ì²­ ë³¸ë¬¸(Body) ìƒì„±
        const requestBody = {
            channel: "email",
            to: "briskly0415@fourberry.co.kr,won567567@fourberry.co.kr,lsj8376@fourberry.co.kr", // ìš”ì²­ ëª…ì„¸ì— ë”°ë¦„
            subject: `[í¬ë² ë¦¬ ë¬¸ì˜] ${clientInfo.value.company || clientInfo.value.name} ë‹˜ - ${typeLabel}`,
            content: htmlContent,
            data: {
                // (API ëª…ì„¸ì˜ data ê°ì²´ê°€ í…œí”Œë¦¿ ë³€ìˆ˜ìš©ì´ë¼ë©´, 
                //  ì—¬ê¸°ì—ë„ ì£¼ìš” ì •ë³´ë¥¼ ë„£ì–´ì£¼ëŠ” ê²ƒì´ ì¢‹ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)
                clientName: clientInfo.value.name,
                clientCompany: clientInfo.value.company,
                inquiryType: typeLabel
            },
            attachments: attachments
        };

        // 5. API í˜¸ì¶œ (Nuxt 3ì˜ $fetch ì‚¬ìš©)
        await $fetch('https://briskly0714.cafe24.com/lime/api/v1/messages/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': 'msg_fourberry_clipsight_d7288f6917991ca3c414f15c86535a09'
                // (ë§Œì•½ ì¸ì¦ í† í°ì´ í•„ìš”í•˜ë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€)
                // 'Authorization': 'Bearer YOUR_API_KEY'
            },
            body: requestBody,
        });

        // 6. ì„±ê³µ ì²˜ë¦¬
        openModal('ì „ì†¡ ì™„ë£Œ', 'ë¬¸ì˜ê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.', 'success');

    } catch (error) {
        // 7. ì‹¤íŒ¨ ì²˜ë¦¬
        console.error('ë¬¸ì˜ ì „ì†¡ ì‹¤íŒ¨:', error);
        // CORS ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        // ì„œë²„ ì¸¡ì—ì„œ 'https://briskly0714.cafe24.com' APIë¥¼ í˜¸ì¶œí•˜ë„ë¡ 
        // Nuxt ì„œë²„ ë¼ìš°íŠ¸(/server/api/contact.post.ts)ë¥¼ ë§Œë“œëŠ” ê²ƒì´ ë” ì•ˆì •ì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        openModal('ì „ì†¡ ì‹¤íŒ¨', 'ë¬¸ì˜ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
    } finally {
        // 8. ë¡œë”© ìƒíƒœ í•´ì œ
        isLoading.value = false;
    }
};
</script>

<style lang="scss" scoped></style>
